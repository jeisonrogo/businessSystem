# Arquitectura del Sistema - Documentaci√≥n de Implementaci√≥n

Este documento explica la arquitectura actual implementada del Sistema de Gesti√≥n Empresarial, describiendo qu√© hace cada archivo y c√≥mo se organizan los componentes siguiendo los principios de Clean Architecture.

## üìã Principios Arquitect√≥nicos Aplicados

### Clean Architecture
- **Separaci√≥n de responsabilidades** por capas bien definidas
- **Inversi√≥n de dependencias** - las capas internas no conocen las externas
- **Independencia de frameworks** - la l√≥gica de negocio no depende de FastAPI o PostgreSQL
- **Facilidad para testing** - cada capa puede probarse de forma aislada

### Inyecci√≥n de Dependencias
- **FastAPI Depends** para inyecci√≥n autom√°tica de dependencias
- **Repositorios abstractos** para desacoplar la l√≥gica de negocio del acceso a datos

---

## üèóÔ∏è Estructura de Archivos Implementada

### `/backend/main.py` - Punto de Entrada Principal
**Prop√≥sito:** Archivo de arranque de la aplicaci√≥n FastAPI

**Funciones:**
- Inicializa la aplicaci√≥n FastAPI con metadatos (t√≠tulo, descripci√≥n, versi√≥n)
- Configura middleware de CORS para permitir peticiones del frontend
- **‚úÖ NUEVO:** Incluye router de autenticaci√≥n (`/api/v1/auth`)
- Define endpoints b√°sicos:
  - `GET /` - Informaci√≥n b√°sica de la API
  - `GET /health` - Endpoint de verificaci√≥n de salud del servicio
- Configuraci√≥n para ejecutar con Uvicorn cuando se ejecuta directamente

**Dependencias:** FastAPI, FastAPI CORS middleware, router de autenticaci√≥n

---

## üìÅ Capa de Dominio - Modelos de Negocio

### `/backend/app/domain/models/user.py` - Modelo de Usuario
**Prop√≥sito:** Define la entidad User y esquemas relacionados siguiendo Domain-Driven Design

**Componentes implementados:**
- **`UserBase`** - Campos base compartidos (email, nombre, rol)
- **`User`** - Entidad principal con tabla SQLModel:
  - `id: UUID` - Identificador √∫nico
  - `email: str` - Email √∫nico con √≠ndice
  - `nombre: str` - Nombre completo (2-100 caracteres)
  - `rol: str` - Rol del usuario (defecto: "vendedor")
  - `hashed_password: str` - Contrase√±a hasheada con bcrypt
  - `created_at: datetime` - Fecha de creaci√≥n (UTC)
  - `is_active: bool` - Estado activo (defecto: True)
- **`UserCreate`** - Schema para creaci√≥n (incluye password en texto plano)
- **`UserRead`** - Schema de lectura (excluye password)
- **`UserUpdate`** - Schema de actualizaci√≥n (campos opcionales)
- **`UserRole`** - Constantes de roles:
  - `ADMINISTRADOR` - Acceso total al sistema
  - `GERENTE_VENTAS` - Gesti√≥n de ventas y facturaci√≥n
  - `CONTADOR` - Gesti√≥n contable y reportes
  - `VENDEDOR` - Rol b√°sico por defecto

**Reglas de negocio implementadas:**
- BR-06: Usuarios solo acceden a funciones permitidas por su rol
- Email √∫nico obligatorio
- Contrase√±as siempre hasheadas, nunca en texto plano
- Uso de `datetime.now(UTC)` para evitar deprecation warnings

**Dependencias:** SQLModel, Pydantic, UUID, datetime

---

## üìÅ Capa de Aplicaci√≥n - L√≥gica de Negocio

### `/backend/app/application/services/i_user_repository.py` - Interfaz de Repositorio
**Prop√≥sito:** Define el contrato abstracto para el acceso a datos de usuarios

**M√©todos implementados:**
- `create(user_data: UserCreate) -> User` - Crear usuario
- `get_by_id(user_id: UUID) -> Optional[User]` - Buscar por ID
- `get_by_email(email: str) -> Optional[User]` - Buscar por email
- `get_all(skip: int, limit: int) -> List[User]` - Listar con paginaci√≥n
- `update(user_id: UUID, user_data: UserUpdate) -> Optional[User]` - Actualizar
- `delete(user_id: UUID) -> bool` - Eliminar (soft delete)
- `exists_by_email(email: str) -> bool` - Verificar existencia
- `count_total() -> int` - Contar usuarios activos

**Principios aplicados:**
- Dependency Inversion Principle (DIP)
- Repository Pattern
- Interface Segregation Principle (ISP)

**Dependencias:** ABC, UUID, domain models

### `/backend/app/application/use_cases/auth_use_cases.py` - Casos de Uso de Autenticaci√≥n
**Prop√≥sito:** Implementa la l√≥gica de negocio para autenticaci√≥n

**Casos de uso implementados:**

1. **`LoginUseCase`**:
   - Autentica credenciales (email + password)
   - Verifica usuario activo
   - Genera token JWT
   - Retorna token + informaci√≥n del usuario

2. **`RegisterUseCase`**:
   - Valida rol de usuario
   - Verifica unicidad de email
   - Crea usuario con contrase√±a hasheada
   - Genera token JWT para auto-login
   - Retorna token + usuario creado

3. **`GetCurrentUserUseCase`**:
   - Valida token JWT
   - Obtiene usuario actualizado de BD
   - Verifica estado activo
   - Retorna informaci√≥n del usuario

**Excepciones personalizadas:**
- `AuthenticationError` - Credenciales inv√°lidas, usuario inactivo
- `RegistrationError` - Errores en registro (email duplicado, rol inv√°lido)

**Dependencias:** IUserRepository, AuthenticationUtils, domain models

---

## üìÅ Capa de Infraestructura - Implementaciones Concretas

### `/backend/app/infrastructure/database/session.py` - Configuraci√≥n de Base de Datos
**Prop√≥sito:** Maneja la conexi√≥n y configuraci√≥n de la base de datos

**Funciones actualizadas:**
- **‚úÖ NUEVO:** Import del modelo User para Alembic
- Define `DATABASE_URL` con PostgreSQL: `postgresql+psycopg://admin:admin@localhost:5432/inventario`
- Crea el `engine` de SQLAlchemy con configuraci√≥n optimizada
- `create_db_and_tables()` - Funci√≥n para crear tablas desde metadatos
- `get_session()` - Generador para inyecci√≥n de dependencias

**Dependencias:** SQLModel, SQLAlchemy, User model

### `/backend/app/infrastructure/repositories/user_repository.py` - Repositorio de Usuarios
**Prop√≥sito:** Implementaci√≥n concreta del repositorio usando PostgreSQL

**Caracter√≠sticas implementadas:**
- Implementa todas las operaciones de `IUserRepository`
- **Hash autom√°tico de contrase√±as** con bcrypt
- **Validaci√≥n de unicidad** de emails
- **Soft delete** - marca como inactivo en lugar de eliminar
- **Manejo robusto de transacciones** con rollback autom√°tico
- **Paginaci√≥n** en consultas de listado
- **Manejo de excepciones** espec√≠ficas (IntegrityError, ValueError)

**M√©todos implementados:**
- Hash y verificaci√≥n de contrase√±as con `passlib`
- B√∫squedas con filtros de usuario activo donde corresponde
- Validaciones de negocio antes de operaciones de BD
- Queries optimizadas con SQLModel/SQLAlchemy

**Dependencias:** SQLModel, SQLAlchemy, passlib, IUserRepository

### `/backend/app/infrastructure/auth/auth_utils.py` - Utilidades de Autenticaci√≥n
**Prop√≥sito:** Maneja JWT tokens y operaciones criptogr√°ficas

**Configuraci√≥n:**
- `SECRET_KEY` - Desde variable de entorno
- `ALGORITHM` - HS256 para JWT
- `ACCESS_TOKEN_EXPIRE_MINUTES` - 30 minutos por defecto

**M√©todos implementados:**
- `hash_password(password)` - Hash con bcrypt
- `verify_password(plain, hashed)` - Verificaci√≥n de contrase√±a
- `create_access_token(data, expires_delta)` - Crear JWT
- `verify_token(token)` - Validar y decodificar JWT
- `authenticate_user(email, password, user)` - Validar credenciales
- `create_user_token(user)` - JWT espec√≠fico para usuario
- `get_user_from_token(token)` - Extraer datos del usuario desde JWT

**Clases de datos:**
- `TokenData` - Representaci√≥n de datos del token
- `LoginCredentials` - Credenciales de login

**Dependencias:** python-jose, passlib, datetime, User model

---

## üìÅ Capa de Presentaci√≥n - API REST

### `/backend/app/api/v1/schemas.py` - Esquemas Pydantic
**Prop√≥sito:** Define modelos de entrada y salida para la API

**Esquemas de autenticaci√≥n:**
- `LoginRequest` - Email + password con validaciones
- `LoginResponse` - Token + tipo + informaci√≥n del usuario
- `RegisterRequest` - Datos completos de registro
- `RegisterResponse` - Token + usuario + mensaje de confirmaci√≥n
- `UserResponse` - Informaci√≥n de usuario sin datos sensibles

**Esquemas de error:**
- `ErrorResponse` - Manejo consistente de errores
- `ValidationErrorResponse` - Errores de validaci√≥n espec√≠ficos

**Esquemas generales:**
- `TokenResponse` - Solo token y tipo
- `HealthResponse` - Estado del servicio
- `MessageResponse` - Respuestas con mensaje simple

**Validaciones implementadas:**
- `EmailStr` para emails v√°lidos
- Longitudes m√≠nimas/m√°ximas para campos
- Campos requeridos vs opcionales
- Descripciones para documentaci√≥n autom√°tica

**Dependencias:** Pydantic, datetime, UUID

### `/backend/app/api/v1/endpoints/auth.py` - Endpoints de Autenticaci√≥n
**Prop√≥sito:** Maneja las rutas HTTP para autenticaci√≥n

**Endpoints implementados:**

1. **`POST /api/v1/auth/register`** (201 Created):
   - Registra nuevos usuarios
   - Validaciones de entrada con Pydantic
   - Manejo de errores: 400 (datos inv√°lidos), 409 (email duplicado), 422 (validaci√≥n)

2. **`POST /api/v1/auth/login`** (200 OK):
   - Autenticaci√≥n con email/password
   - Retorna JWT token
   - Manejo de errores: 401 (credenciales inv√°lidas), 422 (validaci√≥n)

3. **`GET /api/v1/auth/me`** (200 OK):
   - Informaci√≥n del usuario autenticado
   - Requiere Bearer token en Authorization header
   - Manejo de errores: 401 (token inv√°lido), 404 (usuario no encontrado)

**Caracter√≠sticas:**
- **HTTPBearer security** para autenticaci√≥n con tokens
- **Inyecci√≥n de dependencias** con `get_user_repository`
- **Manejo de errores consistente** con c√≥digos HTTP apropiados
- **Documentaci√≥n autom√°tica** con OpenAPI/Swagger
- **Validaci√≥n autom√°tica** de requests con Pydantic

**Dependencias:** FastAPI, HTTPBearer, casos de uso, repositorio, esquemas

---

## üß™ Sistema de Pruebas Implementado

### `/backend/tests/test_infrastructure/test_user_repository.py` - Pruebas de Repositorio
**Prop√≥sito:** 15 pruebas unitarias del repositorio de usuarios

**Cobertura de pruebas:**
- ‚úÖ Creaci√≥n exitosa de usuarios
- ‚úÖ Validaci√≥n de email duplicado
- ‚úÖ B√∫squedas por ID y email (exitosas y fallidas)
- ‚úÖ Listado con paginaci√≥n
- ‚úÖ Actualizaci√≥n de datos y contrase√±as
- ‚úÖ Eliminaci√≥n (soft delete)
- ‚úÖ Verificaci√≥n de existencia y conteo

**Configuraci√≥n de pruebas:**
- SQLite en memoria para aislamiento
- Fixtures con engine, session, repositorio y datos de ejemplo
- Configuraci√≥n independiente por cada prueba

### `/backend/tests/test_api/test_auth_endpoints.py` - Pruebas de Endpoints
**Prop√≥sito:** 15 pruebas de integraci√≥n de la API

**Cobertura de pruebas:**
- ‚úÖ Registro exitoso y validaciones
- ‚úÖ Login exitoso y credenciales inv√°lidas
- ‚úÖ Usuario inactivo y emails inexistentes
- ‚úÖ Endpoint `/me` con tokens v√°lidos e inv√°lidos
- ‚úÖ Validaciones de formularios (emails, contrase√±as)
- ‚úÖ Flujo completo de autenticaci√≥n
- ‚úÖ Manejo de errores HTTP apropiados

**Configuraci√≥n de pruebas:**
- TestClient de FastAPI con base de datos en memoria
- Override de dependencias para aislamiento
- Fixtures para cliente, sesi√≥n y datos de ejemplo

---

## üóÑÔ∏è Migraciones de Base de Datos

### `/backend/alembic/versions/4e467837c286_add_users_table.py` - Migraci√≥n de Usuarios
**Prop√≥sito:** Crea la tabla users en PostgreSQL

**Estructura creada:**
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY,
    email VARCHAR NOT NULL,
    nombre VARCHAR(100) NOT NULL,
    rol VARCHAR NOT NULL DEFAULT 'vendedor',
    hashed_password VARCHAR NOT NULL,
    created_at TIMESTAMP NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE
);
CREATE UNIQUE INDEX ix_users_email ON users (email);
```

**Correcci√≥n aplicada:**
- Agregado `import sqlmodel` para resolver dependencias de tipos

---

## üîÑ Flujo de Datos Implementado

### Endpoint de Registro - Ejemplo de Flujo Completo

```mermaid
graph TD
    A[Cliente HTTP] -->|POST /auth/register| B[FastAPI Endpoint]
    B --> C[Validaci√≥n Pydantic]
    C --> D[RegisterUseCase]
    D --> E[Validar Rol]
    E --> F[Verificar Email √önico]
    F --> G[SQLUserRepository.create]
    G --> H[Hash Password con bcrypt]
    H --> I[Insert en PostgreSQL]
    I --> J[AuthUtils.create_user_token]
    J --> K[JWT Token Generado]
    K --> L[Response con Token + User]
    L --> A
```

### Endpoint de Login - Flujo de Autenticaci√≥n

```mermaid
graph TD
    A[Cliente HTTP] -->|POST /auth/login| B[FastAPI Endpoint]
    B --> C[Validaci√≥n Pydantic]
    C --> D[LoginUseCase]
    D --> E[SQLUserRepository.get_by_email]
    E --> F[Verificar Usuario Activo]
    F --> G[AuthUtils.verify_password]
    G --> H[AuthUtils.create_user_token]
    H --> I[JWT Token Generado]
    I --> J[Response con Token + User]
    J --> A
```

### Endpoint `/me` - Flujo de Autorizaci√≥n

```mermaid
graph TD
    A[Cliente HTTP] -->|GET /auth/me + Bearer Token| B[HTTPBearer Security]
    B --> C[GetCurrentUserUseCase]
    C --> D[AuthUtils.get_user_from_token]
    D --> E[Validar Token JWT]
    E --> F[SQLUserRepository.get_by_id]
    F --> G[Verificar Usuario Activo]  
    G --> H[Response con User Info]
    H --> A
```

---

## üîß Configuraci√≥n y Variables de Entorno

### Variables de Entorno Implementadas

| Variable | Valor Actual | Prop√≥sito |
|----------|--------------|-----------|
| `DATABASE_URL` | `postgresql+psycopg://admin:admin@localhost:5432/inventario` | Conexi√≥n a PostgreSQL |
| `JWT_SECRET_KEY` | `your-secret-key-change-in-production` | Clave para firmar JWT |
| `ALGORITHM` | `HS256` | Algoritmo de firma JWT |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | `30` | Tiempo de vida del token |

### Dependencias Instaladas (requirements.txt)

```
fastapi                     # Framework web principal
uvicorn[standard]          # Servidor ASGI
sqlmodel                   # ORM + validaci√≥n
psycopg[binary]           # Driver PostgreSQL
alembic                    # Migraciones
pydantic>=2.6.0           # Validaci√≥n de datos
python-jose[cryptography] # JWT tokens
passlib[bcrypt]           # Hash de contrase√±as
pytest                     # Framework de testing
pytest-cov                # Cobertura de pruebas
pytest-asyncio           # Testing as√≠ncrono
python-multipart          # Formularios multipart
email-validator           # Validaci√≥n de emails
httpx                     # Cliente HTTP para pruebas
```

---

## üöÄ Comandos de Desarrollo Actualizados

### Servidor de Desarrollo
```bash
# Desde /backend
source venv/bin/activate
python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### Migraciones
```bash
# Crear nueva migraci√≥n
alembic revision --autogenerate -m "descripci√≥n del cambio"

# Aplicar migraciones
alembic upgrade head

# Ver historial
alembic history

# Ver estado actual
alembic current
```

### Testing
```bash
# Todas las pruebas (30 pruebas)
pytest

# Solo repositorio (15 pruebas)
pytest tests/test_infrastructure/

# Solo API (15 pruebas)
pytest tests/test_api/

# Con cobertura detallada
pytest --cov=app --cov-report=html
```

### Pruebas de API Manual
```bash
# Registrar usuario
curl -X POST "http://localhost:8000/api/v1/auth/register" \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "nombre": "Test User", "rol": "vendedor", "password": "password123"}'

# Hacer login
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "password": "password123"}'

# Obtener usuario actual (reemplazar TOKEN)
curl -X GET "http://localhost:8000/api/v1/auth/me" \
  -H "Authorization: Bearer TOKEN_JWT_AQUI"
```

---

## üìã Estado de Implementaci√≥n por Componente

| Componente | Estado | Descripci√≥n |
|------------|--------|-------------|
| **FastAPI Base** | ‚úÖ Implementado | Servidor con endpoints de auth |
| **Configuraci√≥n BD** | ‚úÖ Implementado | SQLModel + PostgreSQL funcionando |
| **Migraciones** | ‚úÖ Implementado | Tabla users creada |
| **Modelo User** | ‚úÖ Implementado | Entidad completa con roles |
| **Repositorio User** | ‚úÖ Implementado | CRUD completo con validaciones |
| **Casos de Uso Auth** | ‚úÖ Implementado | Login, Register, GetCurrentUser |
| **Endpoints Auth** | ‚úÖ Implementado | 3 endpoints funcionando |
| **Sistema de Testing** | ‚úÖ Implementado | 30 pruebas (100% pasando) |
| **Autenticaci√≥n JWT** | ‚úÖ Implementado | Tokens funcionando |
| **Autorizaci√≥n RBAC** | ‚è≥ Preparado | Roles definidos, middleware pendiente |
| **Gesti√≥n de Productos** | ‚è≥ Pendiente | Pr√≥xima fase |
| **Sistema de Inventario** | ‚è≥ Pendiente | Pr√≥xima fase |

---

## üîç Puntos de Extensi√≥n Preparados

### Para Implementar Autorizaci√≥n por Roles:
1. Crear middleware de autorizaci√≥n en `/app/infrastructure/auth/`
2. Decorator `@require_role()` para endpoints
3. Dependency `get_current_user_with_role()` para FastAPI

### Para Agregar Nuevos Modelos (Productos):
1. Crear entidad en `/app/domain/models/product.py`
2. Crear interfaz en `/app/application/services/i_product_repository.py`
3. Implementar en `/app/infrastructure/repositories/product_repository.py`
4. Generar migraci√≥n con Alembic
5. Casos de uso en `/app/application/use_cases/product_use_cases.py`
6. Endpoints en `/app/api/v1/endpoints/products.py`
7. Esquemas en `/app/api/v1/schemas.py`
8. Pruebas en `/tests/`

### Para Implementar Middleware de Autorizaci√≥n:
```python
# Ejemplo de estructura preparada
async def get_current_active_user(token: str = Depends(oauth2_scheme)):
    # Usar GetCurrentUserUseCase
    pass

async def require_role(required_role: str):
    def role_checker(current_user: User = Depends(get_current_active_user)):
        if current_user.rol != required_role:
            raise HTTPException(403, "Insufficient permissions")
        return current_user
    return role_checker
```

---

## üìä M√©tricas del Sistema

### Cobertura de C√≥digo
- **30 pruebas** implementadas (100% exitosas)
- **15 pruebas** de infraestructura (repositorio)
- **15 pruebas** de presentaci√≥n (API)
- **Cobertura esperada:** >95% en l√≥gica de negocio

### Arquitectura Clean
- **4 capas** bien definidas con responsabilidades claras
- **Inversi√≥n de dependencias** aplicada correctamente
- **Separaci√≥n de concerns** entre autenticaci√≥n, persistencia y presentaci√≥n
- **Testabilidad** m√°xima con mocks e inyecci√≥n de dependencias

### Performance
- **JWT tokens** con expiraci√≥n de 30 minutos
- **Connection pooling** configurado en PostgreSQL
- **Consultas optimizadas** con √≠ndices en campos clave
- **Soft delete** para mantener integridad referencial

El sistema est√° ahora completamente preparado para la **Fase 3: Gesti√≥n de Productos e Inventario** üöÄ
